#General
type Transaction @entity(immutable: true) {
  id: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type User @entity(immutable: false) {
  id: Bytes!
  email: String! # string (unique via mapping)
  phoneNumber: String! # string (unique via mapping)
  username: String! # string
  usernameLowercase: String! @unique # string
  fullName: String! # string
  accountId: BigInt! @unique # uint256
  photo: String! # string
  emailIsOriginal: Boolean! # true if email was provided at creation
  phoneIsOriginal: Boolean! # true if phone was provided at creation
  lastPhotoUpdate: BigInt! # uint256
  lastProfileUpdate: BigInt! # uint256 - timestamp of last profile/contact update
  createdAt: BigInt! # uint256
  hasProfile: Boolean! # bool
  repCategory: Int!
  totalReputation: BigInt! # uint256
  totalLatePayments: BigInt! # uint256
  totalCirclesCompleted: BigInt! # uint256
  totalGoalsCompleted: BigInt! # uint256
  activePersonalGoals: [PersonalGoal!]! @derivedFrom(field: "user")
  personalGoals: [PersonalGoalCreated!]! @derivedFrom(field: "user")
  earlyWithdrawals: [GoalWithdrawn!]! @derivedFrom(field: "user")
  circlesCreated: [CircleCreated!]! @derivedFrom(field: "user")
  circlesJoined: [CircleJoined!]! @derivedFrom(field: "user")
  circlesCompleted: [CircleCompleted]! @derivedFrom(field: "user")
  profileUpdates: [ProfileUpdated!]! @derivedFrom(field: "user")
  contactInfoUpdates: [ContactInfoUpdated!]! @derivedFrom(field: "user")
}

#User Profile
type ProfileCreated @entity(immutable: true) {
  id: Bytes!
  user: User!
  transaction: Transaction!
}

type ProfileUpdated @entity(immutable: true) {
  id: Bytes!
  user: User!
  fullName: String! # string
  photo: String! # string
  transaction: Transaction!
}

type ContactInfoUpdated @entity(immutable: true) {
  id: Bytes!
  user: User!
  email: String! # string
  phoneNumber: String! # string
  transaction: Transaction!
}

#User Reputation
type LatePaymentRecorded @entity(immutable: true) {
  id: Bytes!
  user: User!
  circleId: BigInt! # uint256
  round: BigInt! # uint256
  fee: BigInt! # uint256
  transaction: Transaction!
}

type CircleCompleted @entity(immutable: true) {
  id: Bytes!
  user: User!
  circleId: BigInt! # uint256
  transaction: Transaction!
}

type GoalCompleted @entity(immutable: true) {
  id: Bytes!
  user: User!
  goalId: BigInt! # uint256
  transaction: Transaction!
}

type ReputationDecreased @entity(immutable: false) {
  id: Bytes!
  user: User!
  points: BigInt! # uint256
  reason: String! # string
  transaction: Transaction!
}

type ReputationIncreased @entity(immutable: false) {
  id: Bytes!
  user: User!
  points: BigInt! # uint256
  reason: String! # string
  transaction: Transaction!
}

type ScoreCategoryChanged @entity(immutable: false) {
  id: Bytes!
  user: User!
  oldCategory: Int!
  newCategory: Int!
  transaction: Transaction!
}

#Personal Goal Savings
type PersonalGoal @entity(immutable: false) {
  id: Bytes! # goalId as Bytes
  user: User!
  goalId: BigInt! # uint256
  goalName: String! # string
  goalAmount: BigInt! # uint256
  currentAmount: BigInt! # uint256
  contributionAmount: BigInt! # uint256
  frequency: Int!
  deadline: BigInt! # uint256
  isActive: Boolean! # bool
  createdAt: BigInt! # uint256
  updatedAt: BigInt! # uint256
  token: Bytes! # address
  isYieldEnabled: Boolean! # bool
}

type PersonalGoalCreated @entity(immutable: true) {
  id: Bytes!
  user: User!
  goalId: BigInt! # uint256
  goalName: String! # string
  goalAmount: BigInt! # uint256
  currentAmount: BigInt! # uint256
  contributionAmount: BigInt! # uint256
  frequency: Int!
  deadline: BigInt! # uint256
  isActive: Boolean! # bool
  token: Bytes! # address
  transaction: Transaction!
}

type GoalContribution @entity(immutable: true) {
  id: Bytes!
  user: User!
  amount: BigInt! # uint256
  goalId: BigInt! # uint256
  token: Bytes! # address
  transaction: Transaction!
}

type GoalWithdrawn @entity(immutable: true) {
  id: Bytes!
  user: User!
  goalId: BigInt! # uint256
  amount: BigInt! # uint256
  penalty: BigInt! # uint256
  isActive: Boolean! # bool
  token: Bytes! # address
  transaction: Transaction!
}

type YieldDistributed @entity(immutable: true) {
  id: Bytes!
  user: User!
  goalId: BigInt! # uint256
  yieldAmount: BigInt! # uint256
  platformShare: BigInt! # uint256
  token: Bytes! # address
  transaction: Transaction!
}

#Circle Savings
# Mutable entity tracking current circle state
type Circle @entity(immutable: false) {
  id: Bytes! # circleId as Bytes
  circleId: BigInt! # uint256
  creator: User!
  circleName: String! # string
  circleDescription: String! # string
  currentRound: BigInt! # uint256
  contributionAmount: BigInt! # uint256
  collateralAmount: BigInt! # uint256
  frequency: Int!
  maxMembers: BigInt! # uint256
  currentMembers: BigInt! # uint256
  visibility: Int! # 0 = Private(default), 1 = Public
  state: Int! # 0 = PENDING, 1 = CREATED, 2 = VOTING, 3 = ACTIVE, 4 = COMPLETED, 5 = DEAD
  createdAt: BigInt! # uint256
  startedAt: BigInt! # uint256 (0 if not started)
  updatedAt: BigInt! # uint256
  lastVoteExecuted: VoteExecuted # Reference to last vote
  voteWithdrawWon: Boolean
}

# Immutable event for circle creation
type CircleCreated @entity(immutable: true) {
  id: Bytes!
  user: User!
  circleId: BigInt! # uint256
  circleName: String! # string
  circleDescription: String! # string
  circleContributionAmount: BigInt! # uint256
  collateralAmount: BigInt! # uint256
  circleFrequency: Int!
  circleMaxMembers: BigInt! # uint256
  circleVisibility: Int! # 0 = Private(default), 1 = Public
  circleCreatedAt: BigInt! # uint256
  transaction: Transaction!
}

# Immutable event for each member joining
type CircleJoined @entity(immutable: true) {
  id: Bytes!
  circleId: BigInt! # uint256
  user: User!
  currentMembers: BigInt! # uint256
  circleState: Int!
  transaction: Transaction!
}

type CircleStarted @entity(immutable: true) {
  id: Bytes!
  circleId: BigInt! # uint256
  circleStartedAt: BigInt! # uint256
  transaction: Transaction!
}

type ContributionMade @entity(immutable: true) {
  id: Bytes!
  user: User!
  circleId: BigInt! # uint256
  round: BigInt! # uint256
  amount: BigInt! # uint256
  transaction: Transaction!
}

type PositionAssigned @entity(immutable: false) {
  id: Bytes!
  user: User!
  circleId: BigInt! # uint256
  position: BigInt! # uint256
  transaction: Transaction!
}

type MemberForfeited @entity(immutable: true) {
  id: Bytes!
  forfeiter: User!
  circleId: BigInt! # uint256
  round: BigInt! # uint256
  deductionAmount: BigInt! # uint256
  forfeitedUser: User!
  transaction: Transaction!
}

type VisibilityUpdated @entity(immutable: true) {
  id: Bytes!
  circleId: BigInt! # uint256
  transaction: Transaction!
}

type VotingInitiated @entity(immutable: true) {
  id: Bytes!
  circleId: BigInt! # uint256
  votingStartAt: BigInt! # uint256
  votingEndAt: BigInt! # uint256
  transaction: Transaction!
}

type VoteCast @entity(immutable: true) {
  id: Bytes!
  voter: User!
  circleId: BigInt! # uint256
  choice: Int!
  transaction: Transaction!
}

type VoteExecuted @entity(immutable: true) {
  id: Bytes!
  circleId: BigInt! # uint256
  circleStarted: Boolean!
  startVoteTotal: BigInt! # uint256
  withdrawVoteTotal: BigInt! # uint256
  transaction: Transaction!
  withdrawWon: Boolean! # True if startVoteTotal < 51% of total votes
}

type PayoutDistributed @entity(immutable: true) {
  id: Bytes!
  user: User!
  circleId: BigInt! # uint256
  round: BigInt! # uint256
  payoutAmount: BigInt! # uint256
  transaction: Transaction!
}

type CollateralWithdrawn @entity(immutable: true) {
  id: Bytes!
  user: User!
  circleId: BigInt! # uint256
  amount: BigInt! # uint256
  transaction: Transaction!
}

type MemberInvited @entity(immutable: true) {
  id: Bytes!
  inviter: User!
  invitee: User!
  circleId: BigInt! # uint256
  invitedAt: BigInt!
  transaction: Transaction!
}

type CollateralReturned @entity(immutable: true) {
  id: Bytes!
  user: User!
  circleId: BigInt! # uint256
  amount: BigInt! # uint256
  transaction: Transaction!
}

type DeadCircleFeeDeducted @entity(immutable: true) {
  id: Bytes!
  circleId: BigInt! # uint256
  creator: User!
  deadFee: BigInt! # uint256
  transaction: Transaction!
}
